name: "Build and Push"
description: "Build and push AlmaLinux bootc image to registry"

inputs:
  VERSION_MAJOR:
    description: "Major version of AlmaLinux (e.g. 8, 9, 10)"
    required: true
  DATE_STAMP:
    description: "Date stamp for the image tag (e.g. 20231001)"
    required: true
  IMAGE_REGISTRY:
    description: "Docker registry to push the image to (e.g. quay.io/almalinuxorg)"
    default: "quay.io/almalinuxorg"
    required: true
  REGISTRY_USER:
    description: "Username for the Docker registry"
    required: true
  REGISTRY_PASSWORD:
    description: "Password for the Docker registry"
    required: true
runs:
  using: "composite"
  steps:
    - name: Prepare environment
      shell: bash
      run: |
        # Platform / arch
        platform="${{ env.PLATFORM }}"
        ARCH=${platform#linux/}
        [ "x${ARCH}" != "x" ] && echo "ARCH=${ARCH}" >> "$GITHUB_ENV"

        # Platform / machine
        MACHINE=x86_64
        [ "$ARCH" = "arm64" ] && MACHINE=aarch64
        echo "MACHINE=${MACHINE}" >> "$GITHUB_ENV"

        # Minor version
        VERSION_MINOR=
        if [[ ${{ inputs.VERSION_MAJOR }} != *'kitten'* ]]; then
          almalinux_release=https://repo.almalinux.org/almalinux/almalinux-release-latest-${{ inputs.VERSION_MAJOR }}.${MACHINE}.rpm
          # TODO: remove when AlmaLinux 10.0 is released
          [ "${{ inputs.VERSION_MAJOR }}" = "10" ] && almalinux_release=https://vault.almalinux.org/almalinux-release-latest-10-beta.${MACHINE}.rpm
          release=$(rpm -q --qf="%{VERSION}\n" ${almalinux_release} 2>/dev/null)
          VERSION_MINOR=.$(cut -d '.' -f 2 <<< "$release")
        fi
        echo "VERSION_MINOR=${VERSION_MINOR}" >> "$GITHUB_ENV"

        # quay.io/almalinuxorg/almalinux-bootc
        IMAGE_DEST=${{ inputs.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}
        echo "IMAGE_DEST=${IMAGE_DEST}" >> "$GITHUB_ENV"

    - name: Check update
      shell: bash
      run: |
        # 'dnf check-update'
        # exit codes:
        #   0 - no updates
        #   100 - updates available
        #   125 - tag/platform not found
        #   127 - command not found
        res=0
        sudo podman run --quiet --rm ${{ inputs.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.VERSION_MAJOR }} dnf check-update || res=$?
        echo "res=${res}" >> "$GITHUB_ENV"
        echo "Exit code: '$res'"

    - name: Build image
      if: ${{ env.res != 0 }}
      shell: bash
      run: |
        make image \
          PLATFORM=${{ env.PLATFORM }} \
          IMAGE_NAME=${{ env.IMAGE_NAME }} \
          VERSION_MAJOR=${{ inputs.VERSION_MAJOR }}

    - name: Run Image
      if: ${{ env.res != 0 }}
      shell: bash
      run: sudo podman run --rm -ti ${{ env.IMAGE_NAME }} bootc --version

    - name: Log in to registry
      if: ${{ env.res != 0 }}
      shell: bash
      run: sudo podman login ${{ inputs.IMAGE_REGISTRY }} -u ${{ inputs.REGISTRY_USER }} -p ${{ inputs.REGISTRY_PASSWORD }}

    - name: Push to registry
      if: ${{ env.res != 0 }}
      shell: bash
      run: |
        # Tag: VERSION_MAJOR.VERSION_MINOR-DATE_STAMP-ARCH
        sudo podman push ${{ env.IMAGE_NAME }} \
          docker://${IMAGE_DEST}:${{ inputs.VERSION_MAJOR }}${{ env.VERSION_MINOR }}-${{ inputs.DATE_STAMP }}-${{ env.ARCH }}
